# Smart Contract Code Coverage

Neo-Test can collect code coverage from tests that use [TestApplicationEngine](https://github.com/ngdenterprise/neo-blockchaintoolkit-library/blob/master/src/bctklib/smart-contract/TestApplicationEngine.cs).

> Note, this documentation is for collecting smart contract code coverage from tests written in C#. 
  The contracts themselves can be written in languages other than C#, but the tests have to be written
  in C# to use this coverage collection. Neo.Test.Runner can be used to run tests and collect coverage
  without using C#.

## Add Neo.Collector package to test project

The code coverage collector is distributed in the Neo.Collector NuGet package. Like other NuGet package references,
the test project must contain a `PackageReference` for Neo.Collector. Since the package is used at build time,
the `IncludeAssets` and `PrivateAssets` values must be set as per the example below.

``` xml
<ItemGroup>
  <PackageReference Include="Neo.Collector" Version="$(NeoTestVersion)" >
    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    <PrivateAssets>all</PrivateAssets>
  </PackageReference>
</ItemGroup>
```

## Create a .runsettings file (Optional) 

In order to generate contract coverage, Neo.Collector needs the
[contract debug info](https://github.com/neo-project/proposals/blob/master/nep-19.mediawiki)
for any contract being tested. Test projects that specify `NeoContractReference` items
generate a C# interface from the contract manifest for use in test collateral. This 
C# interface includes a custom `[NeoTestHarness.Contract]` attribute that specifies the
contract's name and path to the manifest file that was used to generate the interface.

The collector will automatically locate the debug info for any type that specifies the 
`[NeoTestHarness.Contract]` attribute, assuming the debug info is in the same folder as
the manifest and has the same base name. 

To collect coverage for contracts that aren't referenced by `NeoContractReference` items,
you can explicitly include them via a 
[`.runsettings` file](https://learn.microsoft.com/en-us/visualstudio/test/configure-unit-tests-by-using-a-dot-runsettings-file).

To do this, create a file in your test project with a `.runsettings` extension. The basename
of this file does not matter. Inside this file, place the following XML.

``` xml
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="Neo code coverage">
        <Configuration>
          <DebugInfo>(path to .nefdbgnfo file)</DebugInfo>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
```

You may include multiple `DebugInfo` elements withing the `Configuration` element if there are multiple
contracts under test that you wish to collect coverage for.

> Note, if you want to see verbose logging of the coverage collection process, you can add a `<VerboseLog>true</VerboseLog>`
  element to the `Configuration` element in the `.runsettings` file

## Specify Neo.Collector when running tests

To collect coverage information when running tests, you can enable Neo.Collector on the command line 
or via your test project file.

Regardless of how it is enabled, Neo.Collector generate multiple files during a test run. These files 
are generated by default in the `TestResults/<test run guid>` folder of your test project. 

* `neo-coverage.cobertura.xml` - this file contains code coverage in the [Cobertura](https://github.com/cobertura/cobertura)
  format. This is the same format generated by default by the `coverlet.collector`, which is
  [popular](https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-code-coverage?tabs=windows#integrate-with-net-test)
  in the .NET ecosystem. 
* `<contract hash>.neo-coverage.txt` - this file contains raw address code coverage inforamtion in a
  simple text format. One `.neo-coverage.txt` will be generated for each contract with debug info encountered
  during test execution. Each line of the file will have either
  * two numbers, indicating the address and hit count for any non-branch instruction
  * three numbers, indicating the address, branch count and continue count for any branch instruction

### Collecting Coverage via Command Line 

You trigger code coverage collection when running `dotnet test` by adding the `--collect:"Neo code coverage"`
argument. If you have `.runsettings` file as described above, you must also use the `--settings` argument to
specify the path to that runsettings file.

Example:

``` shell
dotnet test --collect:"Neo code coverage" --settings test/neo-code-cov.runsettings
```

### Collecting Coverage via Test .csproj File 

You can configure code coverage to be collected every time `dotnet test` is run by adding the `<VSTestCollect>` 
property to the test project's .csproj file. If you have `.runsettings` file as described above, you may speciify
that path via the `<RunSettingsFilePath>` property

Example:

```xml
  <PropertyGroup>
    <VSTestCollect>Neo code coverage</VSTestCollect>
    <RunSettingsFilePath>$(MSBuildThisFileDirectory)/test.runsettings</RunSettingsFilePath>
  </PropertyGroup>
```

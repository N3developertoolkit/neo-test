<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" TreatAsLocalProperty="NeoBuildTasksFolder;NeoBuildTasksAssembly">

  <PropertyGroup>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">netstandard2.0</NeoBuildTasksFolder>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">net472</NeoBuildTasksFolder>
    <NeoBuildTasksAssembly>$(MSBuildThisFileDirectory)..\tasks\$(NeoBuildTasksFolder)\neo-build-tasks.dll</NeoBuildTasksAssembly>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoContractInterface"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoCsc"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoExpressBatch"/>

  <Target Name="ConfigureNeoCsc">
    <PropertyGroup>
      <NeoCscOutputFolder Condition="'$(NeoContractOutput)'==''">$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), 'bin\sc'))</NeoCscOutputFolder>
      <NeoCscOutputFolder Condition="'$(NeoContractOutput)'!=''">$(NeoContractOutput)</NeoCscOutputFolder>

      <NeoCscContractPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nef'))</NeoCscContractPath>
      <NeoCscManifestPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).manifest.json'))</NeoCscManifestPath>
      <NeoCscDebugInfoPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nefdbgnfo'))</NeoCscDebugInfoPath>
      <NeoCscAssemblyPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).asm'))</NeoCscAssemblyPath>

      <NeoCscOptimize>true</NeoCscOptimize>
      <NeoCscOptimize Condition="'$(Configuration)'=='Debug'">false</NeoCscOptimize>
      <NeoCscDebug>false</NeoCscDebug>
      <NeoCscDebug Condition="'$(Configuration)'=='Debug'">true</NeoCscDebug>
    </PropertyGroup>

    <ItemGroup>
      <NeoCscOutput Include="$(NeoCscContractPath)" />
      <NeoCscOutput Include="$(NeoCscManifestPath)" />
      <NeoCscOutput Include="$(NeoCscDebugInfoPath)" Condition="'$(NeoCscDebug)'=='true'" />
      <NeoCscOutput Include="$(NeoCscAssemblyPath)" Condition="'$(NeoContractAssembly)'=='true'"/>
    </ItemGroup>
  </Target>

  <Target Name="ExecuteNeoCsc" AfterTargets="Compile" 
    DependsOnTargets="ConfigureNeoCsc"
    Condition="'$(NeoContractName)'!=''"
    Inputs="$(MSBuildProjectFullPath);@(Compile);" Outputs="@(NeoCscOutput)">

    <NeoCsc 
      Assembly="$(NeoContractAssembly)"
      BaseFileName="$(NeoContractName)"
      Debug="$(NeoCscDebug)"
      Inline="$(NeoCscOptimize)"
      Optimize="$(NeoCscOptimize)"
      Output="$(NeoContractOutput)"
      Sources="@(Compile)"
      WorkingDirectory="$(MSBuildProjectDirectory)"/>
  </Target>

  <Target Name="NeoCscMessage" AfterTargets="ExecuteNeoCsc" Condition="'$(NeoContractName)'!=''">
    <Message Importance="High" Text="$(NeoContractName) -&gt; $(NeoCscContractPath)" />
  </Target>

  <Target Name="GetNeoContractInfo" Returns="@(NeoContractInfo)" DependsOnTargets="ConfigureNeoCsc">
    <ItemGroup Condition="'$(NeoContractName)'!=''" >
      <NeoContractInfo Include="$(NeoContractName)">
        <NefPath>$(NeoCscContractPath)</NefPath>
        <ManifestPath>$(NeoCscManifestPath)</ManifestPath>
      </NeoContractInfo>
    </ItemGroup>
  </Target>

  <Target Name="ConfigureNeoExpressBatch">
    <PropertyGroup>
      <NeoExpressTouchFile>$([MSBuild]::NormalizePath($(IntermediateOutputPath), '$(NeoExpressBatchFile).neoxp.touch'))</NeoExpressTouchFile>
      <NeoExpressNormalizedBatchFile>$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), $(NeoExpressBatchFile)))</NeoExpressNormalizedBatchFile>
    </PropertyGroup>
  </Target>

  <Target Name="ExecuteNeoExpressBatch"
    AfterTargets="Build" 
    DependsOnTargets="ConfigureNeoExpressBatch;ExecuteNeoCsc"
    Condition="'$(NeoExpressBatchFile)'!=''"
    Inputs="@(NeoCscOutput);$(NeoExpressBatchFile);$(NeoExpressTouchFile)" Outputs="$(NeoExpressTouchFile)">

    <PropertyGroup>
      <NeoExpressBatchReset>true</NeoExpressBatchReset>
      <NeoExpressBatchReset Condition="'$(NeoExpressBatchNoReset)'=='true'">false</NeoExpressBatchReset>
    </PropertyGroup>

    <NeoExpressBatch 
      BatchFile="$(NeoExpressNormalizedBatchFile)" 
      InputFile="$(NeoExpressBatchInputFile)"
      Reset="$(NeoExpressBatchReset)"
      Checkpoint="$(NeoExpressBatchCheckpoint)"
      Trace="$(NeoExpressBatchTrace)"
      StackTrace="$(NeoExpressBatchStackTrace)"
      WorkingDirectory="$(MSBuildProjectDirectory)" />
    <Touch Files="$(NeoExpressTouchFile)" AlwaysCreate="true" />

    <Message Importance="High" Text="NeoExpress Batch -> $(NeoExpressNormalizedBatchFile)" />
  </Target>

  <Target Name="ProcessNeoContractReferences" BeforeTargets="$(BuildDependsOn);Build" Condition="'@(NeoContractReference)'!=''">

    <ItemGroup>
      <ProjectReference Include="@(NeoContractReference)" ReferenceOutputAssembly="false" />
    </ItemGroup>
 
    <MSBuild Projects="@(NeoContractReference)" Targets="GetNeoContractInfo">
      <Output TaskParameter="TargetOutputs" ItemName="NeoContractInfo" />
    </MSBuild>

    <Message Importance="High" Text="NeoContractInfo @(NeoContractInfo) -> %(ManifestPath)" />

  </Target>

  <Target Name="ConfigureNeoContractInterface" Condition="'@(NeoContractInfo)'!=''"
          DependsOnTargets="ProcessNeoContractReferences" BeforeTargets="$(BuildDependsOn);Build" >

    <ItemGroup>
      <NeoContractGeneration Include="%(NeoContractInfo.Identity)">
        <ManifestPath>%(NeoContractInfo.ManifestPath)</ManifestPath>
        <OutputPath>$(IntermediateOutputPath)%(Identity).contract-interface.cs</OutputPath>
        <ContractNameOverride>%(NeoContractInfo.ContractNameOverride)</ContractNameOverride>
      </NeoContractGeneration>
    </ItemGroup>

    <Message Importance="High" Text="Generating %(NeoContractGeneration.Identity) contract interface" />

  </Target>

  <Target Name="GenerateNeoContractInterface" 
          DependsOnTargets="ConfigureNeoContractInterface" AfterTargets="ResolveProjectReferences" 
          Inputs="%(NeoContractGeneration.ManifestPath)" Outputs="%(NeoContractGeneration.OutputPath)">

    <NeoContractInterface
      ManifestFile="%(NeoContractGeneration.ManifestPath)"
      OutputFile="%(NeoContractGeneration.OutputPath)"
      RootNamespace="$(RootNamespace)"
      InterfaceName="%(NeoContractGeneration.ContractNameOverride)"/>

    <ItemGroup>
      <Compile Include="%(NeoContractGeneration.OutputPath)" />
    </ItemGroup>

  </Target>

</Project>
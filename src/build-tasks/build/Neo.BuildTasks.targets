<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" TreatAsLocalProperty="NeoBuildTasksFolder;NeoBuildTasksAssembly">

  <PropertyGroup>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' == 'Core' ">netstandard2.0</NeoBuildTasksFolder>
    <NeoBuildTasksFolder Condition=" '$(MSBuildRuntimeType)' != 'Core' ">net472</NeoBuildTasksFolder>
    <NeoBuildTasksAssembly>$(MSBuildThisFileDirectory)..\tasks\$(NeoBuildTasksFolder)\neo-build-tasks.dll</NeoBuildTasksAssembly>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoContractInterface"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoCsc"/>
  <UsingTask AssemblyFile="$(NeoBuildTasksAssembly)" TaskName="Neo.BuildTasks.NeoExpressBatch"/>

  <Target Name="BeforeExecuteNeoCsc" BeforeTargets="ExecuteNeoCsc" Condition="'$(NeoContract)'=='true'">
    <PropertyGroup>
      <NeoContractName Condition="'$(NeoContractName)' == ''">$(TargetName)</NeoContractName>

      <NeoCscOutputFolder Condition="'$(NeoContractOutput)' == ''">$([MSBuild]::NormalizePath($(MSBuildProjectDirectory), 'bin\sc'))</NeoCscOutputFolder>
      <NeoCscOutputFolder Condition="'$(NeoContractOutput)' != ''">$(NeoContractOutput)</NeoCscOutputFolder>

      <NeoCscContractPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nef'))</NeoCscContractPath>
      <NeoCscManifestPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).manifest.json'))</NeoCscManifestPath>
      <NeoCscDebugInfoPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).nefdbgnfo'))</NeoCscDebugInfoPath>
      <NeoCscAssemblyPath>$([MSBuild]::NormalizePath($(NeoCscOutputFolder), '$(NeoContractName).asm'))</NeoCscAssemblyPath>

      <NeoCscOptimize>true</NeoCscOptimize>
      <NeoCscOptimize Condition="'$(Configuration)'=='Debug'">false</NeoCscOptimize>
    </PropertyGroup>

    <ItemGroup>
      <NeoCscOutput Include="$(NeoCscContractPath)" />
      <NeoCscOutput Include="$(NeoCscManifestPath)" />
      <NeoCscOutput Include="$(NeoCscDebugInfoPath)" Condition="'$(DebugSymbols)'=='true'" />
      <NeoCscOutput Include="$(NeoCscAssemblyPath)" Condition="'$(NeoContractAssembly)'=='true'"/>
    </ItemGroup>
  </Target>

  <Target Name="ExecuteNeoCsc" AfterTargets="Compile" Condition="'$(NeoContract)'=='true'"
    Inputs="$(MSBuildProjectFullPath);@(Compile);" Outputs="@(NeoCscOutput)">

    <NeoCsc 
      Files="$(MSBuildProjectFullPath)"
      Output="$(NeoContractOutput)"
      ContractName="$(NeoContractName)"
      Assembly="$(NeoContractAssembly)"
      Debug="$(DebugSymbols)"
      Inline="$(Optimize)"
      Optimize="$(Optimize)"
    />
  </Target>

  <Target Name="AfterExecuteNeoCsc" AfterTargets="ExecuteNeoCsc" Condition="'$(NeoContract)'=='true'">
    <Message Importance="High" Text="$(NeoContractName) -&gt; $(NeoCscContractPath)" />
  </Target>

  <Target Name="BeforeExecuteNeoExpressBatch" BeforeTargets="ExecuteNeoExpressBatch" Condition="'$(NeoExpressBatchFile)'!=''">
    <PropertyGroup>
      <NeoExpressTouchFile>$([MSBuild]::NormalizePath($(IntermediateOutputPath), '$(NeoExpressBatchFile).neoxp.touch'))</NeoExpressTouchFile>
    </PropertyGroup>
  </Target>

  <Target Name="ExecuteNeoExpressBatch" AfterTargets="ExecuteNeoCsc" Condition="'$(NeoExpressBatchFile)'!=''"
    Inputs="@(NeoCscOutput);$(NeoExpressBatchFile);$(NeoExpressTouchFile)" Outputs="$(NeoExpressTouchFile)">

    <NeoExpressBatch BatchFile="$(NeoExpressBatchFile)" Reset="true" />
    <Touch Files="$(NeoExpressTouchFile)" AlwaysCreate="true" />
  </Target>

  <Target Name="AfterExecuteNeoExpressBatch" AfterTargets="ExecuteNeoExpressBatch" Condition="'$(NeoExpressBatchFile)'!=''">
    <Message Importance="High" Text="Run $(NeoExpressBatchFile)" />
  </Target>

</Project>